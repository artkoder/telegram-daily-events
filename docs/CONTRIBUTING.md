# Codex Prompt ‚Äî **Telegram Event Bot (MVP v0.1-rev2)**
_–°–∫–æ–ø–∏—Ä—É–π —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –≤ `docs/CONTRIBUTING.md`. –û–Ω ‚Äî ¬´–∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–µ –¢–ó¬ª –¥–ª—è –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö PR._

---

## 0. –¶–µ–ª—å

Telegram-–±–æ—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∞–Ω–æ–Ω—Å—ã –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π, —Ö—Ä–∞–Ω–∏—Ç –∏—Ö, –ø—É–±–ª–∏–∫—É–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç –∏ –≤—ã–¥–∞—ë—Ç —Ç–µ–∫—Å—Ç –¥–ª—è Telegra.ph.
–ü–µ—Ä–≤–∞—è –≤–µ—Ä—Å–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ **SQLite-—Ñ–∞–π–ª–µ** (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ç–æ–º Fly.io). –ú–∏–≥—Ä–∞—Ü–∏—è –≤–æ –≤–Ω–µ—à–Ω—é—é PostgreSQL (Neon/Supabase) –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ—Å–ª–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏.

---

## 1. –û—á–µ—Ä—ë–¥–Ω–æ—Å—Ç—å –∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è User Stories

| ‚Ññ | –ö–∞–∫ (—Ä–æ–ª—å) | –Ø —Ö–æ—á—É | –ß—Ç–æ–±—ã | Acceptance / –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ |
|---|------------|--------|-------|-----------------------------|
| **US-01** | üíº **–°–∏—Å—Ç–µ–º–∞** | –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ **—Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞** | –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –µ–º—É | `/start` ‚Üí –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ `admins` –ø—É—Å—Ç–∞ ‚Üí `user_id` –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ `is_superadmin=True`. |
| **US-02** | üë§ –°—É–ø–µ—Ä–∞–¥–º–∏–Ω | –ø–µ—Ä–µ—Å–ª–∞—Ç—å –ø–æ—Å—Ç –±–æ—Ç—É | –±–æ—Ç —Ä–∞–∑–æ–±—Ä–∞–ª —Å–æ–±—ã—Ç–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–∏–ª –∏—Ö | ‚ë† –ü–µ—Ä–µ–¥–∞—Ç—å —Ç–µ–∫—Å—Ç ‚Üí 4o.<br>‚ë° –ü–æ–ª—É—á–∏—Ç—å –º–∞—Å—Å–∏–≤ JSON.<br>‚ë¢ **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è**: —Å—Ä–∞–≤–Ω–∏—Ç—å `date(+time)` + `place` ‚Äî –µ—Å–ª–∏ —Å–æ–≤–ø–∞–ª–æ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–ø–∏—Å—å—é, —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å ¬´–æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—É—é¬ª –∫–∞—Ä—Ç–æ—á–∫—É (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤ 4o —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —Å—Ç–∞—Ä–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è).<br>‚ë£ `complete=false` ‚Üí –æ—á–µ—Ä–µ–¥—å –º–æ–¥–µ—Ä–∞—Ü–∏–∏; `complete=true` ‚Üí —Å—Ä–∞–∑—É –≤ –ë–î.<br>‚ë§ –ò—Å—Ö–æ–¥–Ω–æ–µ —Å—ã—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–æ–ª–µ `raw_text` (–Ω–∞ –±—É–¥—É—â–µ–µ –¥–ª—è Web UI). |
| **US-03** | üë§ –°—É–ø–µ—Ä–∞–¥–º–∏–Ω | –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è **Telegra.ph** (`/telegraph`) | —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π Markdown | –®–∞–±–ª–æ–Ω *—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã–π* (`templates/telegraph.md`).<br>–°–æ–±—ã—Ç–∏—è, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –ø–æ–∑–¥–Ω–µ–µ 24 —á, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è `üö©` (–∫—Ä–∞—Å–Ω—ã–π —Ñ–ª–∞–≥) –ø–µ—Ä–µ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º. |
| **US-04** | üë§ –°—É–ø–µ—Ä–∞–¥–º–∏–Ω | –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ | –±—ã—Å—Ç—Ä–æ –ø–æ–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ | `/events` ‚Üí –±–æ—Ç –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫: ¬´üîπ {id} {title} ‚úèÔ∏è¬ª.<br>–ù–∞–∂–∞—Ç–∏–µ ‚úèÔ∏è ‚Üí –±–æ—Ç —à–ª—ë—Ç —Ç–µ–∫—É—â–∏–π JSON –∫–∞—Ä—Ç–æ—á–∫–∏ **—Ü–µ–ª–∏–∫–æ–º**, –∞–¥–º–∏–Ω —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç, –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ. –ë–æ—Ç –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç. |
| **US-05** | üë§ –°—É–ø–µ—Ä–∞–¥–º–∏–Ω | –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤—Ä—É—á–Ω—É—é (`/add`) | –∫–æ–≥–¥–∞ –ø–µ—Ä–µ—Å–ª–∞—Ç—å –Ω–µ—á–µ–≥–æ | –ë–æ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç: ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ LLM –¥–ª—è —Å–∂–∞—Ç–∏—è? ‚úÖ/‚ùå¬ª.<br>–ï—Å–ª–∏ ‚úÖ ‚Üí 4o –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç `short_desc` –∏ —Ç–µ–≥–∏; –µ—Å–ª–∏ ‚ùå ‚Üí –≤–≤–æ–¥—è—Ç—Å—è –≤—Ä—É—á–Ω—É—é. |
| **US-06** | üë§ –°—É–ø–µ—Ä–∞–¥–º–∏–Ω | –≤—ã–∑–≤–∞—Ç—å `/daily` | —É–≤–∏–¥–µ—Ç—å –∞–Ω–æ–Ω—Å –≤ —á–∞—Ç–µ | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ—Ç –∂–µ —à–∞–±–ª–æ–Ω, —á—Ç–æ –∏ –¥–ª—è –∞–≤—Ç–æ–ø—É–±–ª–∏–∫–∞—Ü–∏–∏. |
| **US-07** | üë§ –°—É–ø–µ—Ä–∞–¥–º–∏–Ω | –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–∞–Ω–∞–ª—ã –∏ –≤—Ä–µ–º—è | –±–æ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞–ª, –∫—É–¥–∞ –Ω—É–∂–Ω–æ | `/channels` ‚Üí –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ (–∫–Ω–æ–ø–∫–∏ ¬´‚ûï –¥–æ–±–∞–≤–∏—Ç—å¬ª, ¬´üóëÔ∏è —É–¥–∞–ª–∏—Ç—å¬ª, ¬´‚è∞ –∏–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è¬ª). –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `channels(chat_id, post_time)`. |
| **US-08** | ‚è∞ **–°–∏—Å—Ç–µ–º–∞** | –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∞–Ω–æ–Ω—Å –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é | –∫–æ–Ω—Ç–µ–Ω—Ç –≤—ã—Ö–æ–¥–∏–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ | –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, ¬´—Å–µ–π—á–∞—Å == post_time¬ª. –ü—É–±–ª–∏–∫–∞—Ü–∏—è ‚Üí –¥–æ 3 –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ HTTP-403/429, –∑–∞—Ç–µ–º –∫—Ä–∏—Ç–∏—á–Ω—ã–π –ª–æ–≥. |

### –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∫–∞–∂–¥–æ–π US
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** —á–µ—Ä–µ–∑ `logging` (`INFO` ‚Üí stdout, `ERROR` ‚Üí —Ç–∞–±–ª–∏—Ü–∞ `logs`).
- **–¢–µ—Å—Ç—ã**: –º–∏–Ω–∏–º—É–º unit-—Ç–µ—Å—Ç –ª–æ–≥–∏–∫–∏ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π happy-path (pytest-asyncio).
- **–°—Ç–∏–ª—å**: `black + isort + ruff`.
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `docs/CHANGELOG.md` + –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å—Ö–µ–º.

---

## 2. –°—Ç–µ–∫ –∏ —Ñ–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

telegram-event-bot/
‚îú‚îÄ bot/
‚îÇ ‚îú‚îÄ handlers/ # aiogram routers
‚îÇ ‚îú‚îÄ services/ # parsing, scheduling, templates
‚îÇ ‚îî‚îÄ templates/
‚îú‚îÄ db/
‚îÇ ‚îú‚îÄ models.py # SQLModel (SQLite)
‚îÇ ‚îî‚îÄ seed.py
‚îú‚îÄ templates/
‚îÇ ‚îú‚îÄ event.md
‚îÇ ‚îú‚îÄ daily.md
‚îÇ ‚îî‚îÄ telegraph.md
‚îú‚îÄ docs/
‚îÇ ‚îú‚îÄ PROMPTS.md # 4o prompt + canonical venues
‚îÇ ‚îú‚îÄ USER_STORIES.md
‚îÇ ‚îú‚îÄ ARCHITECTURE.md
‚îÇ ‚îî‚îÄ CHANGELOG.md
‚îú‚îÄ tests/
‚îú‚îÄ Dockerfile
‚îú‚îÄ fly.toml
‚îú‚îÄ requirements.txt
‚îî‚îÄ README.md

* **Python 3.12  +  aiogram 3.x**  
* **SQLite** file ‚Üí –ø–æ–∑–∂–µ PostgreSQL  
* **jinja2** —à–∞–±–ª–æ–Ω—ã  
* **httpx** –¥–ª—è –≤—ã–∑–æ–≤–∞ 4o

---

## 3. –®–∞–±–ª–æ–Ω—ã

### `templates/event.md`
```
#### {{ title }}

{{ short_desc }}
{{ price_block }}

{{ date_time_line }}
```
`templates/daily.md`
—Å–º. –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é (–∏–¥–µ–Ω—Ç–∏—á–Ω–æ).

`templates/telegraph.md`
—Ç–æ—Ç –∂–µ —Ñ–æ—Ä–º–∞—Ç, –Ω–æ –±–µ–∑ –æ–±—ë—Ä—Ç–∫–∏ ¬´–ù–ï –ü–†–û–ü–£–°–¢–ò–¢–ï‚Ä¶¬ª ‚Äî —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ —Ä—É—á–Ω–æ–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏).

## 4. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è 4o (—Ñ–∞–π–ª docs/PROMPTS.md)
```
System: You are an experienced event-parser for Russian Telegram posts.

Task sequence:

1. Split the incoming text into separate events (1-N).
2. For each event return JSON object:
   title, short_desc (‚â§180 chars), date, end_date,
   time, end_time, place, city,
   price, source_url, tags[‚â§3],
   complete (true if title, date, place, city exist)
3. Use exact spelling from the canonical venue list (see below).
4. DO NOT hallucinate: absent ‚Üí null.
5. Return ONLY a JSON array, no comments.

Canonical venues:
‚Ä¢ –î–æ–º –°–µ–º—å–∏ ‚Äî –õ–µ–æ–Ω–æ–≤–∞ 4
‚Ä¢ –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ø–∞—Ä–∫ –£–π–∫—É–ª ‚Äî –ü—Ä–∞–≤–¥–∏–Ω—Å–∫
‚Ä¢ ‚Ä¶

User: {raw_post}
```
(–¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –ø–ª–æ—â–∞–¥–∫–∏ –ø—Ä–æ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—è —Å–ø–∏—Å–æ–∫).

## 5. –°–µ–∫—Ä–µ—Ç—ã (Fly.io secrets)
```
keyvalue
TG_TOKENTelegram Bot API token
O4_API_KEY–∫–ª—é—á –¥–ª—è 4o
WEBHOOK_URLURL –¥–ª—è Telegram webhook (prod)
```

## 6. CI/CD
GitHub Actions:

lint ‚Üí test ‚Üí docker build ‚Üí fly deploy (–Ω–∞ main)

Review-–ø–æ—Ç–æ–∫: –≤–µ—Ç–∫–∞ feature ‚Üí PR ‚Üí —Ä–µ–≤—å—é ‚Üí merge.

–ù–∞—á–Ω–∏ —Å US-01.
–í –∫–∞–∂–¥–æ–º PR –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: –∫–æ–¥, —Ç–µ—Å—Ç—ã, –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –¥–æ–∫–∞ –∏ —Å—Ç—Ä–æ–∫–∞ –≤ CHANGELOG.md.
–í–æ–ø—Ä–æ—Å—ã ‚Äî –≤ Issues —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.

